<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Deteksi Postur Tubuh</title>
  </head>
  <body>
    <h2>Deteksi Postur Tubuh</h2>
    <button onclick="init()">Mulai Deteksi</button>
    <br />
    <canvas id="canvas" width="400" height="400"></canvas>
    <div id="pose-output">Postur Tubuh: -</div>

    <!-- GANTI VERSI TEPAT TENSORFLOW -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

    <script>
      const URL = "https://teachablemachine.withgoogle.com/models/2yEqkW4kP/";
      let model, webcam, ctx, canvas, maxPredictions;

      async function init() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmPose.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        const size = 400;
        const flip = true;
        webcam = new tmPose.Webcam(size, size, flip);
        await webcam.setup();
        await webcam.play();
        window.requestAnimationFrame(loop);

        canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d");
      }

      async function loop() {
        webcam.update();
        await prediksiPostur();
        window.requestAnimationFrame(loop);
      }

      async function prediksiPostur() {
        const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
        const prediction = await model.predict(posenetOutput);

        const tertinggi = prediction.reduce(
          (max, p) => (p.probability > max.probability ? p : max),
          { probability: 0 }
        );

        document.getElementById("pose-output").innerText = `Postur Tubuh: ${
          tertinggi.className
        } (${(tertinggi.probability * 100).toFixed(1)}%)`;

        ctx.drawImage(webcam.canvas, 0, 0);
        if (pose) {
          drawKeypoints(pose.keypoints, 0.5, ctx);
          drawSkeleton(pose.keypoints, 0.5, ctx);
        }
      }

      function drawKeypoints(keypoints, minConfidence, ctx) {
        keypoints.forEach((keypoint) => {
          if (keypoint.score > minConfidence) {
            const { y, x } = keypoint.position;
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, 2 * Math.PI);
            ctx.fillStyle = "red";
            ctx.fill();
          }
        });
      }

      function drawSkeleton(keypoints, minConfidence, ctx) {
        const adjacentKeyPoints = tmPose.getAdjacentKeyPoints(
          keypoints,
          minConfidence
        );
        adjacentKeyPoints.forEach(([from, to]) => {
          ctx.beginPath();
          ctx.moveTo(from.position.x, from.position.y);
          ctx.lineTo(to.position.x, to.position.y);
          ctx.strokeStyle = "green";
          ctx.lineWidth = 2;
          ctx.stroke();
        });
      }
    </script>
  </body>
</html>
